# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/styles/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
## Данные и типы данных, используемые в приложении

Интерфейс карточки товара, которая приходит с сервера

```
interface IProduct {
    id: string;
    title: string;
    description: string;
    category: string;
    price: number;
    image: string
}
```

Интерфейс готового заказа

```
interface IOrder {
    payment: string;
    email: string;
    phone: string;
    address: string;
    total: number;
    items: string[];
}
```

Модель для хранения коллекции карточек на главной

```
interface IMainPage {
    productList: IProduct[];
    preview: string | null;
    getPreview(id: string): IProduct;
}
```

Интерфейс корзины

```
interface IBasket {
  cardsInBasket: TItemBasket[];
	addProduct(value: IProduct): void;
  deleteProduct(id: string): void;
  getTotal(): number;
  clearBasket(): void;
	isInBasket(productId: string): boolean;
	getProductsInBasket(): IProduct[];
	getProductIdsInBasket(): string[];   
}
```
Интерфейс оформления заказа

```
interface IOrderData {
	paymentInfo: TPaymentInfo;
	contactsInfo: TContactsInfo;
	clearPayment(): void;
	clearContacts(): void;
	checkValidation(): boolean;
}
```
Храним категории, потом при выводе карточек на главной
В зависисмости от названия будем подсветку категории соответствующую делать в шаблоне

```
enum CategoryType {
	OTHER = 'другое',
	SOFT_SKILL = 'софт-скил',
	ADDITIONAL = 'дополнительное',
	BUTTON = 'кнопка',
	HARD_SKILL = 'хард-скил',
}
```
Интерфейс карточки товара для хранения карточки в корзине и работы с ней

```
interface ICard {
  id: string;
	index: number;
	description: string;
	image: string;
	inBasket: boolean;
	title: string;
	category: string;
	price: number | null;
}
```
Интерфейс для хранения информации о способе оплаты и адресе доставки

```
interface IOrderInfo {
    payment: TPayment | null;
    address: string;    
}
```

Интерфейс события клика мыши

```
interface ICardAction {
	onClick: (event: MouseEvent) => void;
}
```

Данные для модального окна просмотра корзины

```
type TItemBasket = Pick<IProduct, 'title'|'price'>;
```

Данные покупателя в форме заполнения адреса доставки и выбора формы платежа

```
type TPaymentInfo = Pick<IOrder, 'payment'|'address'>;
```

Данные для выбора типа оплаты

```
type TPayment = 'card' | 'cash';
```

Данные покупателя в форме заполнения контактных данных (телефон и e-mail)

```
export type TContactsInfo = Pick<IOrder, 'email' | 'phone'>;
```

Данные для модального окна успешной оплаты

```
type TOrderSuccessInfo = {orderTotal: number;}
```

Для валидации данных из форм заполнения адреса и контактов
```
export type TFormErrors = Partial<Record<keyof IOrder, string>>;
```

## Архитектура приложения
Код приложения разделен на слои согласно парадигме MVP:
  - слой представления, отвечает за отображение данных на странице,
  - слой данных, отвечает за хранение и изменение данных
  - презентер, отвечает за связь представления и данных.

## Базовый код

### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы:
  - `handleResponse` - обрабатывает ответа с сервера. Если ответ с сервера пришел, то возвращается его в формате json, в противном случае формирует ошибку
  - `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
  - `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.

Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
  - `on` - подписка на событие
  - `onAll` - слушать все события
  - `off` - снять обработчик с события
  - `offAll` - сбросить все обработчики
  - `emit` - инициализация события
  - `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие

### Слой данных

#### Класс ProductsData
Класс отвечает за хранени данных о товарах.
Конструктор класса принимает инстант брокера событий.

В полях класса хранятся следующие данные:

  - _productList: IProduct[] - массив объектов товаров 
  - _preview: string | null - id карточки, выбранной для просмотра в модальном окне
  - events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными:

  - get productsList(): IProduct[] - возвращает массив товаров.
  - getPreview(): string | null - возвращает выбранную карточку товара.

#### Класс BasketData
Класс отвечает за хранение данных товаров в корзинею
Конструктор класса принимает инстант брокера событий.

В полях класса хранятся следующие данные:

  - _cardsInBasket: TItemBasket[] - коллекция товаров в корзине
  - _total: number - итоговая стоимость товаров в корзине
  - events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными:

  - getTotal(): number - сумма заказа
  - getProductIdsInBasket - возвращаем массив id, для отправки заказа на сервер
  - isInBasket - проверяем по id наличие товара в корзине чтобы не добавить дважды
  - getProductsInBasket - возвращаем массив товаров, добавленных в корзине
  - addProduct(product: IProduct) - добавляем товар в корзину и вызывает событие изменение массива
  - deleteProduct(id: string) - удаляем товар из корзины и вызывает событие изменение массива
  - clearBasket - очищаем корзину
  - cardsInBasket - возвращаеv массив карточек добавленных в корзину

#### Класс OrderData
Класс отвечает за хранение и логику работы с данными заказа.
Конструктор класса принимает инстант брокера событий.

В полях класса хранятся следующие данные:

  - _paymentInfo: TPaymentInfo - платежная информация
  - _contactInfo: TContactsInfo - контактная информация
  - order: IOrder - заказ
  - formErrors - ошибки валидации форм
  - events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.

	- clearPayment() - для очистки данных формы заполнения оплаты и адреса доставки
  - clearContacts() для очистки данных формы контактов
  - checkValidation(): boolean - валидирует поля _paymentInfo и _contactInfo и устанавливает ошибки, вызывает событие formErrors:change
  - set paymentInfo(info: TPaymentInfo): void - запись платежной информации
  - set contactsInfo(info: TContactsInfo): void - запись контактной информации
  - get paymentInfo(): TPaymentInfo - возвращает данные о способе оплаты и адресе
  - get contacstInfo(): TContactsInfo - возвращает контактную информацию
	- validateContactInfo() - валидирует форму контактов и устанавливает событие сontacts:ready
  - validatePaymentInfo() - валидирует форму оплаты и устанавливает событие сontacts:ready
  -	updateInputFields( field: keyof IOrder, value: string ) - валидируем инпуты, на случай если пользователь стер даннве из инпутов, чтобы повторно отработала checkValidation, в случае пустых инпутов

### Классы представления

Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Класс Component
Абстрактный класс Component является дженериком и служит шаблоном для классов слоя представления

Поля класса:

  - _container: HTMLElement - DOM элемент, передаваемый в конструкторе
  - events: IEvents - объект класса EventEmitter для инициации событий при изменении данных.

Параметры в конструкторе:

  - container: HTMLElement - DOM элемент компонента
  - events: IEvents - объект класса EventEmitter для инициации событий при изменении данных.

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

  - render(data?: Partial<T>): HTMLElement - возвращает отрисованный html элемент по переданным данным
  - toggleClass - Переключает наличие CSS-класса className у элемента element
  - setText - Устанавливает текстовое содержимое элемента element значением value
  - setDisabled - Устанавливает состояние блокировки элемента element
  - state - true для блокировки, false для разблокировки
  - setHidden - Скрывает элемент element (устанавливает display: none).
  - setVisible - Показывает элемент element (удаляет свойство display).
  - setImage - Устанавливает источник изображения src и альтернативный текст alt для элемента element.

#### Класс MainPage
Класс расширяет класс Component. Представляет собой компонент для отображения главной страницы приложения, отвечает за отображение списка товаров и иконку корзины покупателя со счетчиком товаров.

Поля класса:

  - _catalog: HTMLElement[] - контейнер для каталога товаров
	- wrapper: HTMLElement - элемент обертки страницы.
  - basketButton: HTMLElement - кнопка открытия корзины в модальном окне
  - _basketCounter: HTMLElement - элемент счетчика товаров в корзине

Методы класса:

  - set locked - устанавливает состояние блокировки страницы.
  - set count - устанавливает счетчик товаров в корзине.
  - set catalog - выводит товары на страницу.

#### Класс Modal
Класс расширяет класс Component. Реализует модальное окно. Предназначен для отображения таких компонентов как PreviewProduct, Basket, Payment, Contacts, Success. Так же представляет методы `open` и `close` для управления отображением модального окна, устанавливает слушатели на клик в оверлей и кнопку-крестик для закрытия попапа.

Поля класса:

  - _content: HTMLElement - содержимое модального окна
  - events: IEvents - брокер событий

Методы класса:

  - open() - метод отображения модального окна, запускает событие, блокирующее прокрутку страницы
  - close() - метод для закрытия модального окна, запускает событие, разблокирующее прокрутку страницы
  - render() - перерисовываем содержимое модального окна

#### Класс Card
Класс расширяет класс Component. Отвечает за отображение карточки товара в каталоге.

Поля класса:
  - events: IEvents - объект класса EventEmitter для инициации событий при изменении данных.
	- cardId: string - ID карточки товара
	- cardTitle: HTMLHeadingElement - элемент заголовка карточки товара
	- cardPrice: HTMLSpanElement - элемент цены карточки товара
	- cardImage: HTMLImageElement - элемент изображения карточки товара
	- cardCategory: HTMLSpanElement - элемент категории карточки товара
	- cardDescription: HTMLParagraphElement - элемент описания карточки товара
	- button: HTMLButtonElement - кнопка карточки товара
	- cardIndex: HTMLSpanElement - индекс карточки товара

В конструктор передается элемент карточки и объект с обработчиком события. По клику на карточку открывается модальное окно с информацией о товаре.

Методы класса:
  - category(value: CategoryType) -  Устанавливает категорию
  - set index(index: number) - устанавливает индекс товара для корзины
  - get id(): string - получаем id выбранного товара
  - set id(id: string) - сохраняем id выбранного товара
  - get title(): string - получаем заголовок
  - set title(title: string) - устанавливаем заголовок
  - set price(price: number | null) - устанавливаем цену
  - set description(description: string) - устанавливаем описание
  - set image(src: string) - устанавливаем изображение
  - set inBasket(state: boolean) - меняем состояние кнопки

#### Класс Basket
Класс расширяет класс Component. Отвечает за отображение списка выбранных товаров и общей стоимости заказа.

Поля класса:

  - _basketList: HTMLElement - элемент-контейнер списка товаров
  - _basketTotal: HTMLElement - элемент с текстом об общей стоимости товаров в корзине
  - button: HTMLButtonElement - кнопка оформить

В конструктор передается элемент корзины и объект с обработчиком события. Обработчик устанавливается на кнопку начала заказа. Если в корзине нет товаров, кнопка заблокирована.

Методы класса:

  - set basketTotal - записываем общую стоимость товаров к корзине
  - set basketList - записываем список товаров в корзине
  - disableButton() - блокируем кнопку оформления заказа, если корзина пустая

#### Класс Form
Класс расширяет класс Component. Является абстрактным классом дженериком и шаблоном для форм приложения. Реализует пользовательский функционал с формами.

Поля класса:

  - _submit: HTMLButtonElement - кнопка отправки данных формы
  - _errors: HTMLElement - html элемент для отображения текста ошибок формы, при наличии/отсутствии ошибок - блокирует/разблокирует кнопку подтверждения данных формы.

Методы класса:

  - onInputChange() - получает инпуты формы и отслеживает их изменения
  - set valid(value: boolean) - сеттер для блокировки/разблокировки кнопки submit
  - set errors(value: string) - установка текста ошибок

#### Класс Payment
Класс расширяет класс Component. Отвечает за отображение первого окна формы заказа. Расширяет базовый класс Form.

Поля класса:

  - inputAddress: HTMLInputElement - поле ввода адреса доставки заказа
  - buttonCard: HTMLButtonElement - оплата онлайн
  - buttonCash: HTMLButtonElement - оплата при получении заказа
  - orderButtonElement: HTMLButtonElement - кнопка формы

Методы класса:

  - handlePaymentButtonClick() - переключение способа оплаты
  - get payment(): TPayment - возвращает способ оплаты
  - get address(): string - возвращает адрес доставки заказа
  - set payment - записывает способ оплаты
  - set address - записывает адресс

#### Класс Contacts
Класс расширяет класс Component. Отвечает за отображение второго окна формы заказа. Класс расширяет базовый класс Form.

Устанавливает значения следующих элементов:

Поля класса:

  - inputEmail: HTMLInputElement - поле ввода адреса email
  - inputPhone: HTMLInputElement - поле ввода телефона

Методы класса:

  - get email(): string - возвращает email
  - get phone(): string - возвращает номер телефона
  - set email(): string - записывает email
  - set phone(): string - записывает номер телефона

#### Класс Success
Класс расширяет класс Component. Отвечает за отображение блока подтверждения заказа.

Поля класса:

  - button: HTMLButtonElement - кнопка "За новыми покупками"
  - _orderTotal: HTMLElement - элемент для отображения общей стоимости заказа

Методы класса:

  - set orderTotal(total: number): void - устанавливает количество потраченных средств

### Слой коммуникации

#### Класс WebLarekApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

Методы класса:

  - getProducts(): Promise<ICard[]> - получает с сервера массив объектов всех товаров
  - getProductById(id: string): Promise<ICard> - получает с сервера конкретный товар по id
  - postOrder(order: IOrder): Promise<TSuccessData> - отправляет post запрос на сервер, содержащий данные о заказе и получает по итогу номер заказа (id) и общую сумму заказ (total).

## Взаимодействие компонентов

Код, описывающий взаимодействие представления и данных между собой находится в файле index.ts, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в index.ts\
В index.ts сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

Список событий, которые могут генерироваться в системе:

События изменения данных (генерируются классами моделями данных):
  - cards:changed - изменение массива данных продуктов
  - productList:changed - изменение массива покупок
  - success:changed - событие, возникающее при получении успешного заказа.

События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление):

  - modal:open - открытие модального окна
  - modal:closed - закрытие модального окна
  - cards:changed - вывод карточек на страницу, изменение списка товаров в корзине (при добавлении и удалении товара)
  - preview:selected - выбор карточки товара для отображения в модальном окне
  - card:toBasket - добавление товара в корзину
  - basket:open - открытие корзины товаров
  - basket:delete - удаление товара из корзины
  - basket:order - нажатие на кнопку оформления заказа в корзине
  - order:valid - взаимодействие пользователя с полями формы доставки
  - contacts:valid - заимодействие пользователя с полями формы контактов
  - formErrors:change - изменилось состояние валидации формы
  - orderInput:change - изменились введенные данные
  - payment:submit - успешное прохождение формы со способом оплаты и адреса
  - contacts:submit - успешное прохождение формы контактных данных.
  - success: submit - успешное оформлении заказа и возвращение к списку товаров
  
### Примеры взаимодействия

  Пользователь кликнул по карточке товара в галерее:
   - Действие приложения перешло в класс Card (это класс отображения View).
   - Обработчик события клика, привязанный в Card к элементу карточки товара в галерее, вызывает метод emit посредника (класса EventEmitter, Present), который вызывает обработчик события 'card:select', передавая ему данные - объект конкретного товара, по карточке которого кликнули.
   - Обработчик card:select, получая данные, вызывает метод модели (класса AppApi, Model) setPreview, который в свою очередь опять вызывает метод посредника emit, который вызывает обработчик события preview:change, и передаёт ему данные - объект конкретного товара.
   - В свою очередь в обработчике  события preview:change выполнение приложения переходит в класс Modal (опять View), который с помощью своих методов  отрисовывает модальное окно конкретного товара, получая его данные.

  Пользователь кликнул по кнопке открытия корзины:
   - View-Presenter: Пользователь кликнул по кнопке открытия корзины. Обработчик события клика, привязанный в MainPage к элементу иконки корзины, вызывает метод emit посредника (класса EventEmitter, Present), который вызовет обработчик события basket:open.

   - Present-Model: Обработчик basket:open на основе данных, которые у нас хранятся в модели данных basketData.cardsInBasket формирует карточки и вешает событие events.emit('basket:delete', item) на иконки удаления карточки. Методом getTotal получает список карточек и итоговую сумму товаров в корзине.
   
   - Действие приложения перешло в класс Basket (это класс отображения View). Где на основе сформированного ранее списка карточек.

   - Затем методом modal.open переходим в класс Modal (опять View), который с помощью своих методов  отрисовывает модальное корзины, получая ее данные. Скрывает кнопку оформить при отсутствии товаров.